<mat-card class="api-card">

  <!-- Header -->
  <mat-card-header class="api-card__header">
    <div class="left">
      <h2 class="title">API Endpoints</h2>
      <div class="muted last-check">
        Last checked: {{ lastCheckedAt() ? (lastCheckedAt()! | date:'shortTime') : '—' }}
      </div>
    </div>

    <div class="right">
      <mat-form-field appearance="outline" class="search-field" subscriptSizing="dynamic">
        <mat-label>Search</mat-label>
        <input
          matInput
          type="text"
          [value]="query()"
          (input)="onQuery($any($event.target).value)" />
        <button *ngIf="query()" matSuffix mat-icon-button aria-label="Clear" (click)="onQuery('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <button
        mat-stroked-button
        class="refresh-btn"
        matTooltip="Re-run health checks"
        (click)="refreshAll()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </mat-card-header>

  <!-- Progress (own row) -->
  <div class="progress-wrap" *ngIf="inProgress()">
    <mat-progress-bar
      mode="determinate"
      [value]="progressPct()"
      class="progress">
    </mat-progress-bar>
  </div>

  <!-- Summary tiles -->
  <section class="stats">
    <div class="tile ok">
      <div class="dot"></div>
      <div class="meta"><span class="label">UP</span><span class="value">{{ upCount() }}</span></div>
    </div>
    <div class="tile warn">
      <div class="dot"></div>
      <div class="meta"><span class="label">DEGRADED</span><span class="value">{{ degradedCount() }}</span></div>
    </div>
    <div class="tile down">
      <div class="dot"></div>
      <div class="meta"><span class="label">DOWN</span><span class="value">{{ downCount() }}</span></div>
    </div>
    <div class="tile total">
      <div class="badge">Σ</div>
      <div class="meta"><span class="label">TOTAL</span><span class="value">{{ totalCount() }}</span></div>
    </div>
  </section>

  <mat-card-content>
    <div *ngIf="loadingCfg()" class="muted">Loading endpoints…</div>
    <div *ngIf="error()" class="error">Error: {{ error() }}</div>

    <div class="table-wrap" *ngIf="!loadingCfg() && !error()">
      <table mat-table [dataSource]="filteredRows()" class="mat-elevation-z0 api-table">

        <!-- Name (two-line: name + env pill; url underneath) -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef class="sticky"> Name </th>
          <td mat-cell *matCellDef="let r" class="sticky">
            <div class="cell-name">
              <div class="title">
                {{ r.name }}
                <span class="env-chip" *ngIf="r.environment as env">{{ env }}</span>
              </div>
              <div class="sub">
                <a class="url-link" [href]="r.baseUrl + r.path" target="_blank" rel="noopener">{{ r.baseUrl }}</a>{{ r.path }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Method -->
        <ng-container matColumnDef="method">
          <th mat-header-cell *matHeaderCellDef> Method </th>
          <td mat-cell *matCellDef="let r"><code>{{ r.method }}</code></td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let r">
            <span class="status" [ngClass]="statusClass(r.status)">
              <span class="dot"></span>{{ r.status }}
            </span>
          </td>
        </ng-container>

        <!-- Latency -->
        <ng-container matColumnDef="latency">
          <th mat-header-cell *matHeaderCellDef> Latency </th>
          <td mat-cell *matCellDef="let r">{{ r.latencyMs != null ? (r.latencyMs + ' ms') : '—' }}</td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r" class="actions">
            <button mat-icon-button matTooltip="Details" (click)="openDetails(r)">
              <mat-icon>info</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Open endpoint" (click)="open(r)">
              <mat-icon>open_in_new</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Re-check" (click)="retryRow(r)">
              <mat-icon>refresh</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['name','method','status','latency','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['name','method','status','latency','actions'];"></tr>
      </table>
    </div>
  </mat-card-content>
</mat-card>
